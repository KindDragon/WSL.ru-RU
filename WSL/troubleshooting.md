---
title: Устранение неполадок подсистемы Windows для Linux
description: Содержит подробные сведения о распространенных ошибках и проблемах, с которыми сталкиваются пользователи при выполнении Linux в подсистеме Windows для Linux.
keywords: BashOnWindows, bash, wsl, windows, windowssubsystem, ubuntu
ms.date: 11/15/2017
ms.topic: article
ms.assetid: 6753f1b2-200e-49cc-93a5-4323e1117246
ms.custom: seodec18
ms.localizationpriority: high
ms.openlocfilehash: 24a899df78e705630c6cb95f8719594aec340c5c
ms.sourcegitcommit: 600853005bd2b42d6e47bf36ebed4b868ff2af26
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2019
ms.locfileid: "72987517"
---
# <a name="troubleshooting-windows-subsystem-for-linux"></a>Устранение неполадок подсистемы Windows для Linux

### <a name="bash-loses-network-connectivity-once-connected-to-a-vpn"></a>Bash утрачивает подключение к сети после подключения к сети VPN

Если после подключения к VPN в Windows оболочка Bash утрачивает подключение к сети, попробуйте воспользоваться этим обходным решением в Bash. Это решение позволит вручную переопределить разрешение DNS с помощью `/etc/resolv.conf`.

1. Запишите DNS-сервер виртуальной частной сети. Для этого выполните `ipconfig.exe /all`
2. Создайте копию существующего resolv.conf, выполнив `sudo cp /etc/resolv.conf /etc/resolv.conf.new`
3. Удалить связь с текущим resolv.con, выполнив `sudo unlink /etc/resolv.conf`
4. `sudo mv /etc/resolv.conf.new /etc/resolv.conf`
5. Откройте `/etc/resolv.conf` и сделайте следующее. <br/>
   а) Удалите из файла первую строку с текстом "\# This file was automatically generated by WSL. To stop automatic generation of this file, remove this line." (Этот файл был автоматически создан WSL. Чтобы остановить автоматическое создание этого файла, удалите данную строку). <br/>
   б. Добавьте запись DNS из пункта 1 выше в качестве первой записи в списке DNS-серверов. <br/>
   в. Закройте файл. <br/>

После отключения VPN необходимо будет отменить изменения в `/etc/resolv.conf`. Для этого сделайте следующее.
1. `cd /etc`
2. `sudo mv resolv.conf resolv.conf.new`
3. `sudo ln -s ../run/resolvconf/resolv.conf resolv.conf`

### <a name="starting-wsl-or-installing-a-distribution-returns-an-error-code"></a>При запуске WSL или установке дистрибутива возвращается код ошибки

Выполните [эти инструкции](https://github.com/Microsoft/WSL/blob/master/CONTRIBUTING.md#8-detailed-logs), чтобы получить подробные журналы и сообщить о возникшей проблеме на портале GitHub.

### <a name="updating-bash-on-ubuntu-on-windows"></a>Обновление Bash для Ubuntu в Windows

Два компонента Bash для Ubuntu в Windows могут требовать обновления. 

1. Подсистема Windows для Linux
  
   Обновление этой части Bash для Ubuntu в Windows обеспечит применение всех новых исправлений, описанных в [заметках о выпуске](https://msdn.microsoft.com/en-us/commandline/wsl/release_notes). Убедитесь, что вы подписаны на Программу предварительной оценки Windows и что ваша сборка обновлена. Чтобы обеспечить более точное управление, включая сброс экземпляра Ubuntu, ознакомьтесь со [страницей справочных материалов по командам](https://msdn.microsoft.com/en-us/commandline/wsl/reference).

2. Двоичные файлы пользователя Ubuntu 

   При обновлении этой части Bash для Ubuntu в Windows будут установлены все обновления двоичных файлов пользователя Ubuntu, включая приложения, установленные с помощью apt-get. Чтобы выполнить обновление, выполните следующие команды в Bash.
  
   1. `apt-get update`
   2. `apt-get upgrade`
  
### <a name="apt-get-upgrade-errors"></a>Ошибки apt-get upgrade
Некоторые пакеты используют функции, которые еще не реализованы. Например, `udev`пока не поддерживается и вызывает несколько ошибок `apt-get upgrade`.

Чтобы устранить проблемы, связанные с `udev`, выполните следующие действия.

1. Введите приведенный ниже код в `/usr/sbin/policy-rc.d` и сохраните изменения.
  
   ``` BASH
   #!/bin/sh
   exit 101
   ```
  
2. Добавьте разрешения на выполнение в `/usr/sbin/policy-rc.d`
   ``` BASH
   chmod +x /usr/sbin/policy-rc.d
   ```
  
3. Выполните следующие команды.
   ``` BASH
   dpkg-divert --local --rename --add /sbin/initctl
   ln -s /bin/true /sbin/initctl
   ```
  
### <a name="error-0x80040306-on-installation"></a>"Ошибка: 0x80040306" при установке
Это связано с тем, что мы не поддерживаем устаревшую консоль.
Чтобы отключить устаревшую консоль, выполните следующие действия.

1. Выполните файл cmd.exe.
1. Щелкните правой кнопкой мыши строку заголовка и выберите "Свойства", затем снимите флажок "Использовать прежнюю версию консоли".
1. Нажмите кнопку "ОК".

### <a name="error-0x80040154-after-windows-update"></a>"Ошибка: 0x80040154" после обновления Windows
Компонент "Подсистема Windows для Linux" может быть отключен во время обновления Windows. В этом случае данную функцию Windows необходимо включить заново. Инструкции по включению подсистемы Windows для Linux можно найти в [руководстве по установке](https://msdn.microsoft.com/en-us/commandline/wsl/install_guide#enable-the-windows-subsystem-for-linux-feature-gui).

### <a name="changing-the-display-language"></a>Изменение отображаемого языка
Установщик WSL попытается автоматически изменить языковой стандарт Ubuntu в соответствии с языковым стандартом установки Windows.  Если это нежелательно, можно выполнить приведенную ниже команду, чтобы изменить языковой стандарт Ubuntu после завершения установки.  Чтобы это изменение вступило в силу, потребуется повторно запустить bash.exe.

В приведенном ниже примере языковой стандарт изменяется на EN-US.
``` BASH
sudo update-locale LANG=en_US.UTF8
```

### <a name="installation-issues-after-windows-system-restore"></a>Проблемы установки после восстановления системы Windows
1.  Удалите папку `%windir%\System32\Tasks\Microsoft\Windows\Windows Subsystem for Linux`. <br/>
  **Примечание. Не делайте этого, если дополнительный компонент полностью установлен и работает.**
2.  Включите дополнительный компонент WSL (если он еще не включен).
3.  Reboot
4.  Выполните команду lxrun /uninstall /full
5.  Установите Bash.

### <a name="no-internet-access-in-wsl"></a>Нет доступа к Интернету в WSL
Некоторые пользователи сообщили о проблемах с определенными приложениями брандмауэра, блокирующими доступ к Интернету в WSL.  Сообщили о следующих брандмауэрах:

1. Kaspersky;
1. AVG;
1. Avast.

В некоторых случаях отключение брандмауэра обеспечивает доступ.  В некоторых случаях доступ блокируется просто при наличии установленного брандмауэра.

### <a name="permission-denied-error-when-using-ping"></a>Ошибка "Отказ в разрешении" при проверке связи
#### <a name="anniversary-updatehttpsmsdnmicrosoftcomen-uscommandlinewslrelease_notesbuild-14388-to-windows-10-anniversary-update"></a>[Юбилейное обновление](https://msdn.microsoft.com/en-us/commandline/wsl/release_notes#build-14388-to-windows-10-anniversary-update) 

Для запуска проверки связи в WSL требуются привилегии администратора в Windows.  Чтобы выполнить проверку связи, запустите Bash для Ubuntu в Windows от имени администратора или запустите bash.exe из командной строки или сеанса PowerShell с привилегиями администратора.

#### <a name="build-14926httpsmsdnmicrosoftcomen-uscommandlinewslrelease_notesbuild-14926"></a>[Сборка 14926 и более поздние сборки](https://msdn.microsoft.com/en-us/commandline/wsl/release_notes#build-14926)
  Привилегии администратора больше не требуются.

### <a name="bash-is-hung"></a>Bash перестал отвечать на запросы
Если при работе с Bash вы обнаружите, что Bash перестал отвечать на запросы (или взаимозаблокирован), помогите нам диагностировать проблему путем сбора и передачи дампа памяти. Обратите внимание на то, что выполнение этих действий приведет к сбою системы. Не делайте этого, если вас это не устраивает, либо предварительно сохраните результаты своей работы.  <br/>
Вот как можно собрать дамп памяти.
1. Измените тип дампа памяти на "Полный дамп памяти". При изменении типа дампа запишите текущий тип.
2. Выполните [эти действия](https://techcommunity.microsoft.com/t5/Core-Infrastructure-and-Security/How-to-Force-a-Diagnostic-Memory-Dump-When-a-Computer-Hangs/ba-p/257809), чтобы настроить аварийное завершение с помощью клавиатуры.
3. Воспроизведите взаимоблокировку или прекращение ответа на запросы.
4. Выполните аварийное завершение системы с помощью последовательности клавиш из пункта 2.
5. Произойдет аварийное завершение системы и будет собран дамп памяти.
6. После перезагрузки системы отправьте memory.dmp на адрес электронной почты secure@microsoft.com. По умолчанию файл дампа находится в папке %SystemRoot%\memory.dmp или C:\Windows\memory.dmp, если C: является системным диском. В письме укажите, что дамп предназначен для команды разработчиков WSL или Bash в Windows.
7. Восстановите исходное значение типа дампа памяти.

### <a name="check-your-build-number"></a>Проверка номера сборки

Чтобы узнать архитектуру компьютера и номер сборки Windows, выберите  
**Параметры** > **Система** > **О программе**

Найдите поля **Сборка ОС** и **Тип системы**.  
    ![Снимок экрана с полями "Сборка ОС" и "Тип системы"](media/system.png) 


Чтобы найти номер сборки Windows Server, выполните в PowerShell следующую команду.  
``` PowerShell
systeminfo | Select-String "^OS Name","^OS Version"
```

### <a name="confirm-wsl-is-enabled"></a>Подтверждение включения WSL
Вы можете убедиться, что подсистема Windows для Linux включена, выполнив в PowerShell следующую команду.  
``` PowerShell
Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux
```

### <a name="openssh-server-connection-issues"></a>Проблемы с подключением к серверу OpenSSH
Попытка подключения к серверу SSH завершается следующей ошибкой: "Connection closed by 127.0.0.1 port 22" (Подключение закрыто узлом 127.0.0.1 через порт 22).
1. Убедитесь, что сервер OpenSSH работает
   ``` BASH
   sudo service ssh status
   ```
   и вы следовали указаниям в этом руководстве: https://help.ubuntu.com/lts/serverguide/openssh-server.html.en.
2. Завершите работу службы sshd и запустите sshd в режиме отладки.
   ``` BASH
   sudo service ssh stop
   sudo /usr/sbin/sshd -d
   ```
3. Проверьте журналы запуска и убедитесь, что ключи сервера доступны и в журнале нет сообщений, как показано ниже.
   ```
   debug1: sshd version OpenSSH_7.2, OpenSSL 1.0.2g  1 Mar 2016
   debug1: key_load_private: incorrect passphrase supplied to decrypt private key
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_rsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_dsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_ecdsa_key
   debug1: key_load_private: No such file or directory
   debug1: key_load_public: No such file or directory
   Could not load host key: /etc/ssh/ssh_host_ed25519_key
   ```

Если вы видите такие сообщения и в разделе `/etc/ssh/` отсутствуют ключи, потребуется повторно создать ключи или просто очистить и установить сервер OpenSSH.
```BASH
sudo apt-get purge openssh-server
sudo apt-get install openssh-server
```

### <a name="the-referenced-assembly-could-not-be-found-when-enabling-the-wsl-optional-feature"></a>"Указанная сборка не найдена". Это сообщение может появиться при включении дополнительного компонента WSL.

Данная ошибка связана с неправильным состоянием установки. Чтобы устранить эту проблему, выполните следующие действия.

* Если вы используете команду включения компонента WSL в PowerShell, попробуйте использовать графический пользовательский интерфейс. Для этого откройте меню "Пуск", выполните поиск фразы "Включение или отключение компонентов Windows", а затем из списка выберите "Подсистема Windows для Linux". Этот дополнительный компонент будет установлен.
* Обновите версию Windows, выбрав "Параметры" > "Обновления" и щелкнув "Проверить наличие обновлений".
* Если оба способа не помогли и вам нужно использовать WSL, рассмотрите возможность обновления на месте, переустановив Windows 10 с установочного носителя и выбрав параметр "Сохранить все", чтобы сохранить свои приложения и файлы. Инструкции по такой установке можно найти на странице [Переустановка Windows 10](https://support.microsoft.com/en-us/help/4000735/windows-10-reinstall).